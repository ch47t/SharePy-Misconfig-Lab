version: '3.8'

services:
  # üêç Backend Service
  backend:
    build: ./app
    container_name: sharepy_backend
    restart: always
    # M2: Debug mode enabled
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload 
    volumes:
      - ./app:/app
    environment:
      # M1: Password in clear text in env
      - DB_PASSWORD=postgres
      - JWT_SECRET=secret123 # M15
    networks:
      - sharepy_net

  # üóÑÔ∏è Database
  db:
    image: postgres:15
    container_name: sharepy_db
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: postgres # Weak password
      POSTGRES_DB: sharepy
    ports:
      - "5432:5432" # M12: Database exposed to Internet
    networks:
      - sharepy_net

  # ‚òÅÔ∏è Object Storage (MinIO)
  minio:
    image: minio/minio
    container_name: sharepy_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin # Weak default
    ports:
      - "9000:9000" # M12: MinIO API exposed
      - "9001:9001" # MinIO Console exposed
    networks:
      - sharepy_net

  # üõ†Ô∏è Database Admin Tool
  adminer:
    image: adminer
    container_name: sharepy_adminer
    ports:
      - "8080:8080" # M5: Publicly accessible without extra auth
    networks:
      - sharepy_net

  # üåê Reverse Proxy
  nginx:
    image: nginx:latest
    container_name: sharepy_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./app:/app # Mounting app code to web root for M4
    networks:
      - sharepy_net

networks:
  sharepy_net:
    driver: bridge
